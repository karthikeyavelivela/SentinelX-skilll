import httpx
import re
import logging
from typing import List, Dict
from tenacity import retry, stop_after_attempt, wait_exponential
from app.config import settings

logger = logging.getLogger("vulnguard.exploitdb")

GITHUB_SEARCH_URL = "https://api.github.com/search/repositories"
EXPLOITDB_API = "https://exploit-db.com/search"  # Simplified; real scraping via CSV


class ExploitDBConnector:
    """Connector for GitHub PoC repositories and ExploitDB."""

    def _github_headers(self) -> dict:
        headers = {"Accept": "application/vnd.github.v3+json"}
        if settings.GITHUB_TOKEN:
            headers["Authorization"] = f"token {settings.GITHUB_TOKEN}"
        return headers

    @retry(stop=stop_after_attempt(3), wait=wait_exponential(multiplier=2, min=4, max=30))
    async def search_github_pocs(self, cve_id: str) -> List[Dict]:
        """Search GitHub for PoC exploits matching a CVE ID."""
        results = []
        async with httpx.AsyncClient() as client:
            params = {
                "q": f"{cve_id} exploit OR poc OR proof-of-concept",
                "sort": "stars",
                "order": "desc",
                "per_page": 10,
            }
            response = await client.get(
                GITHUB_SEARCH_URL, params=params, headers=self._github_headers(), timeout=30.0
            )
            response.raise_for_status()
            data = response.json()

            for repo in data.get("items", []):
                results.append({
                    "cve_id": cve_id,
                    "source": "github",
                    "source_url": repo.get("html_url", ""),
                    "title": repo.get("full_name", ""),
                    "description": (repo.get("description") or "")[:500],
                    "exploit_type": "poc",
                    "platform": self._detect_platform(repo),
                    "verified": repo.get("stargazers_count", 0) > 10,
                    "published_date": repo.get("created_at"),
                    "maturity": "poc" if repo.get("stargazers_count", 0) < 50 else "functional",
                })

        logger.info(f"Found {len(results)} GitHub PoCs for {cve_id}")
        return results

    async def bulk_search_pocs(self, cve_ids: List[str]) -> List[Dict]:
        """Search for PoCs for multiple CVEs."""
        all_results = []
        for cve_id in cve_ids:
            try:
                results = await self.search_github_pocs(cve_id)
                all_results.extend(results)
            except Exception as e:
                logger.warning(f"Failed to search PoCs for {cve_id}: {e}")
        return all_results

    @staticmethod
    def _detect_platform(repo: dict) -> str:
        lang = (repo.get("language") or "").lower()
        mapping = {
            "python": "multi",
            "c": "linux",
            "go": "multi",
            "ruby": "multi",
            "powershell": "windows",
            "shell": "linux",
            "java": "multi",
        }
        return mapping.get(lang, "multi")
